---
import BaseLayout from "../layouts/BaseLayout.astro";
import { getCollection, type CollectionEntry } from "astro:content";

const publications = await getCollection("publications");

const byNewest = (a: CollectionEntry<"publications">, b: CollectionEntry<"publications">) => {
  if (a.data.year !== b.data.year) return b.data.year - a.data.year;
  return a.data.title.localeCompare(b.data.title);
};

const sortedPublications = [...publications].sort(byNewest);
const featured = sortedPublications.filter((p) => p.data.featured);
const peerReviewedAll = sortedPublications.filter(
  p => p.data.type?.toLowerCase?.() === "peer-reviewed"
);
const preprintAll = sortedPublications.filter(
  p => p.data.type?.toLowerCase?.() === "preprint"
);

const highlightTargets = [
  "Daniel Sampaio Osório",
  "Osorio DS",
  "Osório, D.S.",
  "Osorio, D.S.",
  "Osório, Daniel S.",
  "Osorio, Daniel S.",
  "Daniel S. Osório",
  "Daniel S. Osorio",
  "Daniel Osório",
  "Daniel Osorio",
  "Osório, D.S",
  "Osorio, D.S",
];

const normalizeName = (value: string) =>
  value
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, " ")
    .trim();

const highlightSet = new Set(highlightTargets.map(normalizeName));

const isHighlightedAuthor = (name: string) => highlightSet.has(normalizeName(name));


---

<BaseLayout
  title="Publications — Daniel Osório"
  description="Peer-reviewed academic publications in cell biology and cytoskeleton research."
>
  <h1 class="text-2xl font-semibold">Publications</h1>

  <div class="mt-12 font-serif leading-relaxed text-slate-800">
    {featured.length > 0 && (
      <>
        <h2 class="text-lg font-semibold font-sans text-slate-900">Featured</h2>
        {featured.length > 0 && (
          <ul class="mt-6 space-y-6">
            {featured.map(({ data, body }) => (
              <li class="rounded-sm border-l-2 border-slate-200 pl-4">
                <h3 class="font-medium">{data.title} ({data.year})</h3>
                <p class="mt-2 text-sm leading-snug text-slate-600">{body}</p>
                <p class="mt-2 text-sm text-slate-500">
                  <span class="font-semibold text-slate-700">{data.journal}</span> ·{" "}
                  {data.authors.map((author, index) => (
                    <span>
                      {index > 0 ? ", " : ""}
                      {isHighlightedAuthor(author) ? (
                        <span class="text-slate-800 underline decoration-slate-500 underline-offset-2">
                          {author}
                        </span>
                      ) : (
                        author
                      )}
                    </span>
                  ))}
                </p>
                {data.link ? (
                  <a class="mt-2 inline-block text-sm text-sky-700 underline" href={data.link}>
                    Read publication
                  </a>
                ) : (
                  <span class="mt-2 inline-block text-sm text-slate-500">Link unavailable</span>
                )}
              </li>
            ))}
          </ul>
        )}
      </>
    )}

    {sortedPublications.length > 0 && (
      <details class="mt-10">
        <summary class="cursor-pointer text-sm font-medium text-slate-600 hover:text-slate-900">
          Show all publications
        </summary>
        <div class="mt-6">
          {peerReviewedAll.length > 0 && (
            <div>
              <h2 class="text-sm font-semibold uppercase tracking-wide text-slate-500 font-sans">
                Peer-reviewed
              </h2>
              <ul class="mt-4 space-y-6">
                {peerReviewedAll.map(({ data, body }) => (
                  <li class="rounded-sm border-l-2 border-slate-200 pl-4">
                    <h3 class="font-medium">{data.title} ({data.year})</h3>
                    <p class="mt-2 text-sm leading-snug text-slate-600">{body}</p>
                    <p class="mt-2 text-sm text-slate-500">
                      <span class="font-semibold text-slate-700">{data.journal}</span> ·{" "}
                      {data.authors.map((author, index) => (
                        <span>
                          {index > 0 ? ", " : ""}
                          {isHighlightedAuthor(author) ? (
                            <span class="text-slate-800 underline decoration-slate-500 underline-offset-2">
                              {author}
                            </span>
                          ) : (
                            author
                          )}
                        </span>
                      ))}
                    </p>
                    {data.link ? (
                      <a class="mt-2 inline-block text-sm text-sky-700 underline" href={data.link}>
                        Read publication
                      </a>
                    ) : (
                      <span class="mt-2 inline-block text-sm text-slate-500">Link unavailable</span>
                    )}
                  </li>
                ))}
              </ul>
            </div>
          )}
          {preprintAll.length > 0 && (
            <div class="mt-8">
              <h2 class="text-sm font-semibold uppercase tracking-wide text-slate-500 font-sans">
                Preprints
              </h2>
              <ul class="mt-4 space-y-6">
                {preprintAll.map(({ data, body }) => (
                  <li class="rounded-sm border-l-2 border-slate-200 pl-4">
                    <h3 class="font-medium">{data.title} ({data.year})</h3>
                    <p class="mt-2 text-sm leading-snug text-slate-600">{body}</p>
                    <p class="mt-2 text-sm text-slate-500">
                      <span class="font-semibold text-slate-700">{data.journal}</span> ·{" "}
                      {data.authors.map((author, index) => (
                        <span>
                          {index > 0 ? ", " : ""}
                          {isHighlightedAuthor(author) ? (
                            <span class="text-slate-800 underline decoration-slate-500 underline-offset-2">
                              {author}
                            </span>
                          ) : (
                            author
                          )}
                        </span>
                      ))}
                    </p>
                    {data.link ? (
                      <a class="mt-2 inline-block text-sm text-sky-700 underline" href={data.link}>
                        Read publication
                      </a>
                    ) : (
                      <span class="mt-2 inline-block text-sm text-slate-500">Link unavailable</span>
                    )}
                  </li>
                ))}
              </ul>
            </div>
          )}
        </div>
      </details>
    )}
  </div>
</BaseLayout>
